# Симулятор Нефтяного Месторождения

Это простой 2D симулятор двухфазной (нефть и вода) фильтрации в пористой среде, написанный на C++. Он использует схему IMPES (неявная по давлению, явная по насыщенности).

## Физика и Численные Методы

Симулятор решает стандартные уравнения двухфазной фильтрации в рамках модели "черной нефти".

### Математическая модель

Симулятор реализует двухфазную (нефть и вода) модель на двумерной декартовой сетке. Уравнения сохранения массы для каждой фазы, учитывающие капиллярное давление ($P_c = P_o - P_w$), выглядят следующим образом:

$$
\nabla \cdot \left( \mathbf{K} \lambda_w \nabla p_w \right) + q_w = \phi \frac{\partial S_w}{\partial t}
$$
$$
\nabla \cdot \left( \mathbf{K} \lambda_o \nabla (p_w + P_c) \right) + q_o = \phi \frac{\partial S_o}{\partial t}
$$

После суммирования и преобразований получается уравнение для давления одной из фаз (например, давления воды $p_w$) и отдельное уравнение для насыщенности.

Уравнение насыщенности решается явно после того, как поле давления становится известно:

$$
\phi \frac{\partial S_w}{\partial t} + \nabla \cdot \left( \mathbf{v}_w \right) + q_w = 0
$$

Где:
- $\lambda_p = k_{rp} / \mu_p$ - подвижность фазы $p$.
- $\mathbf{K}$ - тензор проницаемости.
- $p_w$ - давление воды.
- $q_w, q_o$ - источниковые члены для воды и нефти.
- $\phi$ - пористость.
- $S_w, S_o$ - насыщенности.
- $\mathbf{v}_w$ - скорость Дарси для воды.

### Модель скважин

Скважины моделируются с использованием стандартной **модели скважин Письмена (Peaceman)**. Источниковый/стоковый член для скважины рассчитывается как:

$$
q = WI \cdot \lambda \cdot (p_{bh} - p_{block})
$$

Где $WI$ - это индекс скважины, вычисляемый по формуле:

$$
WI = \frac{2 \pi k h}{\ln(r_e / r_w)}
$$

с эффективным радиусом $r_e = 0.14 \sqrt{\Delta x^2 + \Delta y^2}$.

### Другие модели

- **Относительные фазовые проницаемости**: Модель Кори.
- **Капиллярное давление**: Модель Брукса-Кори.
- **Вязкость флюидов**: Моделируется как функция давления.
- **Линейный решатель**: BiCGSTAB из библиотеки Eigen для уравнения давления.
- **Распараллеливание**: Цикл обновления насыщенности распараллелен с использованием OpenMP.

## Зависимости

-   Компилятор C++17 (например, GCC, Clang)
-   CMake (версия 3.11 или выше)
-   Git
-   Python 3 с библиотеками `matplotlib` и `numpy` для визуализации.
    ```
    pip install matplotlib numpy
    ```

## Сборка

Проект использует CMake для сборки.

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <URL_репозитория>
    cd oil-simulator
    ```

2.  **Создайте директорию для сборки:**
    ```bash
    mkdir build
    cd build
    ```

3.  **Запустите CMake и соберите проект:**
    ```bash
    cmake ..
    make
    ```
    Это создаст два исполняемых файла в директории `build`: `simulator` и `test_runner`.

## Запуск

### Запуск симуляции

Основной исполняемый файл `simulator` принимает один аргумент: путь к файлу с параметрами.

Находясь в директории `build`, выполните:
```bash
./simulator ../data/five_spot.dat
```
Эта команда:
1.  Запустит симуляцию с параметрами из файла `five_spot.dat`.
2.  Сохранит итоговое давление и насыщенность для каждой ячейки в файл `results.txt` в корневой директории проекта.
3.  Автоматически вызовет Python-скрипт для визуализации.
4.  Создаст файлы `pressure_map.png` и `saturation_map.png` в корневой директории проекта.

### Запуск тестов

Исполняемый файл `test_runner` запускает все скомпилированные юнит-тесты.

Находясь в директории `build`, выполните:
```bash
./test_runner
```
Эта команда выполнит тесты и сообщит об их успешном или неуспешном прохождении.

## Структура Проекта

- `src/`: Исходный код и заголовочные файлы C++.
- `data/`: Файлы с параметрами для сценариев симуляции.
- `python/`: Python-скрипт для визуализации.
- `tests/`: Исходный код для юнит-тестов.
- `build/`: Директория для сборки (создается вами).
- `results.txt`: Основной файл с результатами (создается после запуска).
- `*.png`: Файлы с визуализацией (создаются после запуска).
- `CMakeLists.txt`: Главный сборочный скрипт CMake.
- `README.md`: Документация на английском.
- `README.ru.md`: Эта документация на русском.

Этот симулятор использует метод конечных разностей для решения уравнений двухфазной фильтрации (нефть и вода) на двумерной декартовой сетке. Он реализует схему IMPES (неявная по давлению, явная по насыщенности), которая является распространенным подходом в гидродинамическом моделировании.

### Процесс Симуляции

Симуляция выполняется в несколько шагов:

1.  **Инициализация**:
    *   Программа считывает параметры из файла `.dat`, указанного в командной строке. Эти параметры включают размеры сетки, свойства пласта и флюидов, а также параметры для управления временными шагами.
    *   Создается объект `Grid` (сетка), который хранит информацию о геометрии и свойствах каждой ячейки (пористость, проницаемость, давление, насыщенность).
    *   На основе сценария (в данном случае `create_five_spot`) в сетку добавляются скважины: одна нагнетательная в центре и четыре добывающие по углам.

2.  **Основной цикл по времени**:
    *   Симулятор итеративно движется с заданным шагом по времени (`dt`) до тех пор, пока не достигнет общего времени симуляции (`total_time`).
    *   На каждом временном шаге последовательно решаются два основных уравнения:

    a.  **Уравнение Давления (решается неявно)**:
        *   Собирается система линейных уравнений `Ax = b`, где `x` — это вектор давлений в ячейках на новом временном шаге.
        *   Матрица `A` (матрица проводимости) учитывает проницаемость, пористость, вязкость флюидов и геометрию ячеек.
        *   Вектор правой части `b` включает в себя накопление флюида, потоки от скважин и, что важно, **градиенты капиллярного давления**, которые мы недавно добавили.
        *   Эта система решается с помощью библиотеки Eigen, чтобы найти распределение давления по всему пласту.

    b.  **Уравнение Насыщенности (решается явно)**:
        *   Используя новое поле давлений, вычисляются скорости потоков между соседними ячейками.
        *   Закон Дарси используется для определения скорости потока, которая зависит от градиента давления, подвижности флюидов и проницаемости.
        *   На этом шаге также учитывается **капиллярное давление**, что делает поток более реалистичным.
        *   На основе этих потоков явно рассчитывается новое значение насыщенности водой для каждой ячейки.

3.  **Сохранение Результатов**:
    *   После завершения основного цикла итоговые распределения давления и насыщенности сохраняются в текстовый файл.
    *   Вызывается Python-скрипт для визуализации этих данных в виде цветных карт.

### Описание Результатов

После успешного запуска симулятора в директории сборки (`build/`) создаются три файла:

*   `results.txt`:
    *   **Формат**: Текстовый файл в формате CSV (значения, разделенные запятыми).
    *   **Содержимое**: Каждая строка представляет одну ячейку сетки и содержит четыре значения:
        1.  `i`: Индекс ячейки по оси X.
        2.  `j`: Индекс ячейки по оси Y.
        3.  `pressure`: Давление в ячейке в Паскалях (Па) на конец симуляции.
        4.  `saturation`: Насыщенность ячейки водой (доля от 0 до 1) на конец симуляции.

*   `pressure_map.png`:
    *   **Формат**: Изображение PNG.
    *   **Содержимое**: Двумерная карта, визуализирующая распределение давления по пласту. Цветовая схема "viridis" используется для отображения значений, где разные цвета соответствуют разным уровням давления. Это помогает увидеть области высокого и низкого давления.

*   `saturation_map.png`:
    *   **Формат**: Изображение PNG.
    *   **Содержимое**: Двумерная карта распределения насыщенности водой. Цветовая схема "jet" показывает, где находится вода (красные/оранжевые тона) и где осталась нефть (синие тона). Эта карта наглядно демонстрирует движение фронта вытеснения от нагнетательной скважины к добывающим.


## Установка и Запуск

Для сборки проекта требуется `cmake` (версии 3.11+) и компилятор C++ с поддержкой стандарта C++17. Зависимость от библиотеки Eigen загружается автоматически через `FetchContent`. 